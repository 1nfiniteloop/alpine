#!/bin/bash

# Configuration
readonly DEFAULT_DST_PATH=/etc/patch.d


function error() {
    local error_=$1
    >&2 echo -e "ERROR: ${error_}"
}

function print_usage_and_exit() {
    echo -e "\n\tUsage: $(basename $0) [--dst ${DEFAULT_DST_PATH}] <FILE>\n"
    exit 1
}

function file_exists() {
    local file_=$1
    [ -e ${file_} ] || \
        (error "file '${file_}' does not exists." && false)
    return
}

function orig_file_exists() {
    local file_=$1
    [ -e ${file_}~ ] || \
        (error "file '${file_}~' does not exists, cannot make a patch without the original file." && false)
    return
}

function create_patch() {
    local file_=$(readlink -f $1)
    local file_path=$(dirname ${file_})
    local file_name=$(basename ${file_})
    local dst_path=$2
    local workdir=/tmp/mkpatch
    mkdir -p ${workdir}/{a,b}/${file_path} && \
        ([ -e ${workdir}/a${file_} ] || ln -s ${file_}~ ${workdir}/a${file_}) && \
        ([ -e ${workdir}/b${file_} ] || ln -s ${file_}  ${workdir}/b${file_}) && \
        (cd ${workdir} && diff -r a/ b/ > ${dst_path}/${file_name}.patch; [ $? -lt 2 ])
    return
}

POSITIONAL=()
while [[ $# -gt 0 ]]; do
    key="$1"
    case $key in
        --dst)
        DST_PATH=$2
        shift
        shift
        ;;
        *)
        POSITIONAL+=("$1")
        shift
        ;;
    esac
done

set -- "${POSITIONAL[@]}"

readonly FILE=$1

[ -n "${FILE}" ] && \
    file_exists ${FILE} && \
    orig_file_exists ${FILE} && \
    create_patch ${FILE} ${DST_PATH:-$DEFAULT_DST_PATH} || \
    print_usage_and_exit

